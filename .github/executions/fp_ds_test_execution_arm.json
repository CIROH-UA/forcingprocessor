{  
  "commands": [
    "runuser -l ec2-user -c 'rm -rf /home/ec2-user/ngen-datastream && docker rmi -f $(docker images -aq)'",
    "runuser -l ec2-user -c 'cd /home/ec2-user && git clone -b ${BRANCH_NAME} https://github.com/CIROH-UA/forcingprocessor.git'",
    "runuser -l ec2-user -c 'cd /home/ec2-user/forcingprocessor && git clone --single-branch --branch main --depth 1 https://github.com/CIROH-UA/datastreamcli.git'",
    "runuser -l ec2-user -c 'ARCH=aarch64 TAG=latest-arm64 docker compose -f /home/ec2-user/forcingprocessor/docker/docker-compose.yml build forcingprocessor-deps' >> /home/ec2-user/forcingprocessor/docker_build_log.txt 2>&1",
    "runuser -l ec2-user -c 'TAG=latest-arm64 docker compose -f /home/ec2-user/forcingprocessor/docker/docker-compose.yml build forcingprocessor' >> /home/ec2-user/forcingprocessor/docker_build_log.txt 2>&1",
    "runuser -l ec2-user -c 'export DS_TAG=${DS_TAG} && export FP_TAG=${FP_TAG} && echo \"=== DATASTREAM TEST START ===\" >> /home/ec2-user/forcingprocessor/docker_build_log.txt && /home/ec2-user/forcingprocessor/datastreamcli/scripts/datastream -s 202006200100 -e 202006200200 -C NWM_RETRO_V3 -d /home/ec2-user/forcingprocessor/datastreamcli/data/datastream_test -g https://ngen-datastream.s3.us-east-2.amazonaws.com/palisade.gpkg -R /home/ec2-user/forcingprocessor/datastreamcli/configs/ngen/realization_sloth_nom_cfe_pet.json -S ciroh-community-ngen-datastream -o forcingprocessor/test -n 4 2>&1 | tee -a /home/ec2-user/forcingprocessor/datastream_test_output.txt /home/ec2-user/forcingprocessor/docker_build_log.txt; TEST_EXIT_CODE=${PIPESTATUS[0]}; echo \"=== DATASTREAM TEST END (Exit Code: $TEST_EXIT_CODE) ===\" | tee -a /home/ec2-user/forcingprocessor/datastream_test_output.txt /home/ec2-user/forcingprocessor/docker_build_log.txt; aws s3 cp /home/ec2-user/forcingprocessor/docker_build_log.txt s3://ciroh-community-ngen-datastream/forcingprocessor/test/docker_build_log.txt; aws s3 cp /home/ec2-user/forcingprocessor/datastream_test_output.txt s3://ciroh-community-ngen-datastream/forcingprocessor/test/datastream_test_output.txt; exit $TEST_EXIT_CODE'"
  ],
  "run_options":{
    "ii_terminate_instance" : true,
    "ii_delete_volume"      : true,
    "ii_check_s3"           : true,
    "timeout_s"             : 3600,
    "n_retries_allowed"     : 0
  },
  "instance_parameters": {
    "ImageId": "ami-01fc4c78425e127e6",
    "InstanceType": "t4g.large",
    "KeyName": "actions_key_arm",
    "SecurityGroupIds": ["sg-0fcbe0c6d6faa0117"],
    "IamInstanceProfile": {
      "Name": "default_ec2_profile"
    },
    "TagSpecifications": [{
      "ResourceType": "instance",
      "Tags": [{
        "Key": "Name",
        "Value": "arm_docker_buildNtester"
      }]
    }],
    "BlockDeviceMappings": [{
      "DeviceName": "/dev/xvda",  
      "Ebs": {
        "VolumeSize": 32,
        "VolumeType": "gp3"  
      }
    }]
  }
}